<!DOCTYPE html>
<html>
<head>
    <title>Authentication Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 15px; margin: 5px; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Artist Portal Authentication Test</h1>
    
    <div class="test-section">
        <h2>Current Authentication Status</h2>
        <div id="authStatus">Loading...</div>
        <button onclick="checkAuthentication()">Refresh Auth Status</button>
        <button onclick="clearAllData()">Clear All Data & Refresh</button>
    </div>
    
    <div class="test-section">
        <h2>API Test</h2>
        <button onclick="testStatisticsAPI()">Test Statistics API</button>
        <div id="apiResult"></div>
    </div>
    
    <div class="test-section">
        <h2>Manual Cookie Setting (For Testing)</h2>
        <label>User ID: <input type="number" id="testUserId" value="17" /></label>
        <button onclick="setTestCookie()">Set Test Cookie for User</button>
        <div id="cookieResult"></div>
    </div>

    <script>
        function getUserCookie() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'user_login') {
                    return value;
                }
            }
            return null;
        }

        function checkAuthentication() {
            const statusDiv = document.getElementById('authStatus');
            const cookie = getUserCookie();
            
            if (!cookie) {
                statusDiv.innerHTML = '<span class="error">❌ No authentication cookie found</span>';
                return;
            }
            
            const parts = cookie.split('_');
            if (parts.length !== 2) {
                statusDiv.innerHTML = '<span class="error">❌ Invalid cookie format</span>';
                return;
            }
            
            const userId = parts[0];
            const hash = parts[1];
            
            statusDiv.innerHTML = `
                <span class="success">✅ Authentication cookie found</span><br>
                <strong>User ID:</strong> ${userId}<br>
                <strong>Hash:</strong> ${hash.substring(0, 20)}...<br>
                <strong>Full Cookie:</strong> ${cookie.substring(0, 50)}...
            `;
        }

        async function testStatisticsAPI() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = '<span class="info">Testing API...</span>';
            
            try {
                const timestamp = new Date().getTime();
                const response = await fetch(`./API/getArtistStatistics.php?t=${timestamp}`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                const data = await response.json();
                
                let resultHtml = `<h3>API Response (Status: ${response.status})</h3>`;
                
                if (data.success) {
                    resultHtml += `
                        <span class="success">✅ API Success</span><br>
                        <strong>Authenticated User ID:</strong> ${data.data?.artist_id || 'N/A'}<br>
                        <strong>Artist Name:</strong> ${data.data?.artist_info?.first_name || ''} ${data.data?.artist_info?.last_name || ''}<br>
                        <strong>Number of Artworks:</strong> ${data.data?.products?.length || 0}<br>
                        <strong>Number of Galleries:</strong> ${(data.data?.virtual_galleries?.length || 0) + (data.data?.local_galleries?.length || 0)}<br>
                    `;
                    
                    if (data.data?.products?.length > 0) {
                        resultHtml += '<h4>Artworks:</h4><ul>';
                        data.data.products.slice(0, 5).forEach(artwork => {
                            resultHtml += `<li>${artwork.title} (ID: ${artwork.id})</li>`;
                        });
                        if (data.data.products.length > 5) {
                            resultHtml += `<li>...and ${data.data.products.length - 5} more</li>`;
                        }
                        resultHtml += '</ul>';
                    }
                } else {
                    resultHtml += `<span class="error">❌ API Error: ${data.message}</span>`;
                }
                
                resultHtml += `<h4>Raw Response:</h4><pre>${JSON.stringify(data, null, 2)}</pre>`;
                resultDiv.innerHTML = resultHtml;
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">❌ Network Error: ${error.message}</span>`;
            }
        }

        async function setTestCookie() {
            const userId = document.getElementById('testUserId').value;
            const resultDiv = document.getElementById('cookieResult');
            
            try {
                // This would need the actual user's email to generate the correct hash
                // For now, let's fetch it from the server
                const response = await fetch(`./test_authentication_debug.php`);
                const text = await response.text();
                
                resultDiv.innerHTML = `<h4>Server Response:</h4><pre>${text}</pre>`;
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">Error: ${error.message}</span>`;
            }
        }

        function clearAllData() {
            // Clear cookies
            document.cookie.split(";").forEach(function(c) { 
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
            });
            
            // Clear local storage
            localStorage.clear();
            
            // Clear session storage
            sessionStorage.clear();
            
            // Clear caches
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            
            // Refresh page
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        // Auto-check authentication on page load
        window.addEventListener('load', checkAuthentication);
    </script>
</body>
</html>
